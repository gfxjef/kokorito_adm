{% extends "base.html" %}

{% block title %}Agregar Producto - Kokorito Admin{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-plus text-kokorito-600 mr-3"></i>
            Agregar Nuevo Producto
        </h1>
        <p class="text-gray-600">Selecciona el tipo de producto y completa la información requerida</p>
    </div>

    <!-- Product Type Selection -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-list-alt text-kokorito-600 mr-2"></i>
            Tipo de Producto
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <label class="product-type-option">
                <input type="radio" name="product_type" value="personal" class="sr-only">
                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-kokorito-300 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-user text-2xl text-gray-600 mb-2"></i>
                        <div class="font-medium text-gray-900">Personal</div>
                        <div class="text-sm text-gray-500 mt-1">Postres individuales</div>
                    </div>
                </div>
            </label>
            
            <label class="product-type-option">
                <input type="radio" name="product_type" value="molde_rect" class="sr-only">
                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-kokorito-300 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-square text-2xl text-gray-600 mb-2"></i>
                        <div class="font-medium text-gray-900">Molde Rectangular</div>
                        <div class="text-sm text-gray-500 mt-1">Tortas rectangulares</div>
                    </div>
                </div>
            </label>
            
            <label class="product-type-option">
                <input type="radio" name="product_type" value="molde_circular" class="sr-only">
                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-kokorito-300 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-circle text-2xl text-gray-600 mb-2"></i>
                        <div class="font-medium text-gray-900">Molde Circular</div>
                        <div class="text-sm text-gray-500 mt-1">Tortas redondas</div>
                    </div>
                </div>
            </label>
            
            <label class="product-type-option">
                <input type="radio" name="product_type" value="promo" class="sr-only">
                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-kokorito-300 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-percent text-2xl text-gray-600 mb-2"></i>
                        <div class="font-medium text-gray-900">Promoción</div>
                        <div class="text-sm text-gray-500 mt-1">Ofertas especiales</div>
                    </div>
                </div>
            </label>
            
            <label class="product-type-option">
                <input type="radio" name="product_type" value="accesorios" class="sr-only">
                <div class="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-kokorito-300 transition-colors">
                    <div class="text-center">
                        <i class="fas fa-tools text-2xl text-gray-600 mb-2"></i>
                        <div class="font-medium text-gray-900">Accesorios</div>
                        <div class="text-sm text-gray-500 mt-1">Herramientas y accesorios</div>
                    </div>
                </div>
            </label>
        </div>
    </div>

    <!-- Product Form -->
    <form id="product-form" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6" style="display: none;">
        <h2 class="text-lg font-semibold text-gray-900 mb-6">
            <i class="fas fa-edit text-kokorito-600 mr-2"></i>
            Información del Producto
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Nombre -->
            <div class="md:col-span-2">
                <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
                    Nombre del Producto *
                </label>
                <input type="text" id="nombre" name="nombre" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500">
            </div>

            <!-- Descripción -->
            <div class="md:col-span-2">
                <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-2">
                    Descripción *
                </label>
                <textarea id="descripcion" name="descripcion" rows="3" required
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500"></textarea>
            </div>

            <!-- Sabor (Personal, Molde Rect, Molde Circular) -->
            <div id="sabor-field" style="display: none;">
                <label for="sabor" class="block text-sm font-medium text-gray-700 mb-2">
                    Sabor *
                </label>
                <input type="text" id="sabor" name="sabor"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500">
            </div>

            <!-- Porciones (Molde Rect, Molde Circular) -->
            <div id="porciones-field" style="display: none;">
                <label for="porciones" class="block text-sm font-medium text-gray-700 mb-2">
                    Porciones *
                </label>
                <input type="number" id="porciones" name="porciones" min="1"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500">
            </div>

            <!-- Tamaño de Molde (Solo Molde Circular) -->
            <div id="tamano-molde-field" style="display: none;">
                <label for="tamaño_molde" class="block text-sm font-medium text-gray-700 mb-2">
                    Tamaño del Molde (cm) *
                </label>
                <input type="number" id="tamaño_molde" name="tamaño_molde" step="0.01" min="0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500">
            </div>

            <!-- Categoría (no para accesorios) -->
            <div id="categoria-field">
                <label for="categoria" class="block text-sm font-medium text-gray-700 mb-2">
                    Categoría *
                </label>
                <input type="text" id="categoria" name="categoria" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500">
            </div>

            <!-- Precio -->
            <div>
                <label for="precio" class="block text-sm font-medium text-gray-700 mb-2">
                    Precio *
                </label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">S/</span>
                    <input type="number" id="precio" name="precio" step="0.01" min="0" required
                           class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-kokorito-500 focus:border-kokorito-500">
                </div>
            </div>
        </div>

        <!-- Imágenes -->
        <div class="mt-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Imágenes del Producto *
            </label>
            <div id="image-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-kokorito-400 transition-colors drag-area">
                <div id="upload-placeholder">
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-lg text-gray-600 mb-2">Arrastra imágenes aquí o haz clic para seleccionar</p>
                    <p class="text-sm text-gray-500">Formatos permitidos: JPG, PNG, WEBP (máx. 1200px ancho)</p>
                    <input type="file" id="images" name="images" multiple accept=".jpg,.jpeg,.png,.webp" class="hidden">
                    <button type="button" onclick="document.getElementById('images').click()" 
                            class="mt-4 px-6 py-2 bg-kokorito-600 text-white rounded-md hover:bg-kokorito-700 transition-colors">
                        Seleccionar Imágenes
                    </button>
                </div>
                <div id="image-preview" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="mt-8 flex justify-end space-x-4">
            <a href="/" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors">
                Cancelar
            </a>
            <button type="submit" class="px-6 py-2 bg-kokorito-600 text-white rounded-md hover:bg-kokorito-700 transition-colors">
                <i class="fas fa-save mr-2"></i>
                Guardar Producto
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let selectedProductType = null;
    let selectedFiles = [];

    // Product type selection
    document.addEventListener('DOMContentLoaded', function() {
        const typeOptions = document.querySelectorAll('.product-type-option');
        const form = document.getElementById('product-form');
        
        typeOptions.forEach(option => {
            option.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                const div = this.querySelector('div');
                
                // Reset all options
                typeOptions.forEach(opt => {
                    opt.querySelector('div').classList.remove('border-kokorito-500', 'bg-kokorito-50');
                    opt.querySelector('div').classList.add('border-gray-200');
                });
                
                // Select current option
                radio.checked = true;
                div.classList.remove('border-gray-200');
                div.classList.add('border-kokorito-500', 'bg-kokorito-50');
                
                selectedProductType = radio.value;
                showFormFields(selectedProductType);
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth' });
            });
        });
        
        setupImageUpload();
        setupFormSubmission();
    });

    function showFormFields(productType) {
        // Hide all conditional fields first
        document.getElementById('sabor-field').style.display = 'none';
        document.getElementById('porciones-field').style.display = 'none';
        document.getElementById('tamano-molde-field').style.display = 'none';
        document.getElementById('categoria-field').style.display = 'none';
        
        // Clear required attributes
        document.getElementById('sabor').required = false;
        document.getElementById('porciones').required = false;
        document.getElementById('tamaño_molde').required = false;
        document.getElementById('categoria').required = false;
        
        // Show categoria field for all types except accesorios
        if (productType !== 'accesorios') {
            document.getElementById('categoria-field').style.display = 'block';
            document.getElementById('categoria').required = true;
        }
        
        // Show fields based on product type
        if (productType === 'personal' || productType === 'molde_rect' || productType === 'molde_circular') {
            document.getElementById('sabor-field').style.display = 'block';
            document.getElementById('sabor').required = true;
        }
        
        if (productType === 'molde_rect' || productType === 'molde_circular') {
            document.getElementById('porciones-field').style.display = 'block';
            document.getElementById('porciones').required = true;
        }
        
        if (productType === 'molde_circular') {
            document.getElementById('tamano-molde-field').style.display = 'block';
            document.getElementById('tamaño_molde').required = true;
        }
    }

    function setupImageUpload() {
        const uploadArea = document.getElementById('image-upload-area');
        const fileInput = document.getElementById('images');
        const preview = document.getElementById('image-preview');
        const placeholder = document.getElementById('upload-placeholder');

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
        });

        function handleFiles(files) {
            selectedFiles = files.filter(file => {
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
                return validTypes.includes(file.type);
            });

            if (selectedFiles.length > 0) {
                showImagePreview();
            } else {
                showToast('Por favor selecciona imágenes válidas (JPG, PNG, WEBP)', 'error');
            }
        }

        function showImagePreview() {
            placeholder.classList.add('hidden');
            preview.classList.remove('hidden');
            preview.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative group';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-24 object-cover rounded-lg">
                        <button type="button" onclick="removeImage(${index})" 
                                class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 rounded-b-lg truncate">
                            ${file.name}
                        </div>
                    `;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    function removeImage(index) {
        selectedFiles.splice(index, 1);
        if (selectedFiles.length > 0) {
            showImagePreview();
        } else {
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('image-preview').classList.add('hidden');
        }
    }

    function setupFormSubmission() {
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedProductType) {
                showToast('Por favor selecciona un tipo de producto', 'error');
                return;
            }
            
            if (selectedFiles.length === 0) {
                showToast('Por favor selecciona al menos una imagen', 'error');
                return;
            }
            
            showLoading();
            
            try {
                const formData = new FormData();
                formData.append('product_type', selectedProductType);
                
                // Add form fields
                const form = e.target;
                const formElements = form.querySelectorAll('input, textarea, select');
                formElements.forEach(element => {
                    if (element.name && element.value && element.type !== 'file') {
                        formData.append(element.name, element.value);
                    }
                });
                
                // Add images
                selectedFiles.forEach(file => {
                    formData.append('images', file);
                });
                
                const response = await fetch('/products/add', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Producto agregado exitosamente', 'success');
                    setTimeout(() => {
                        window.location.href = '/admin/manage';
                    }, 1500);
                } else {
                    showToast(data.error || 'Error agregando producto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error de conexión', 'error');
            } finally {
                hideLoading();
            }
        });
    }
</script>
{% endblock %} 